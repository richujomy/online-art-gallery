<!-- accounts/templates/admin/artwork_approval.html -->
{% extends "./dashboard.html" %}
{% load static %}
{% block admin_content %}
<div class="container mx-auto px-4 py-8 max-w-6xl overflow-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Artwork Approval Queue</h1>

    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="p-4 rounded-lg mb-2 {% if message.tags == 'success' %} bg-green-500 {% else %} bg-red-500 {% endif %} text-white shadow">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    {% if pending_artworks %}
        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50 border-b border-gray-200">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Designer</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>

                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for artwork in pending_artworks %}
                            <tr class="hover:bg-gray-50" data-artwork-id="{{ artwork.id }}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ artwork.title }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ artwork.designer.username }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <img src="{{ artwork.image.url }}" alt="{{ artwork.title }}" class="h-16 w-16 object-cover rounded">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ artwork.created_at|date:"M d, Y" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button type="button" class="approve-btn bg-green-100 text-green-700 px-3 py-1 rounded-md 
                                hover:bg-green-200 transition" data-id="{{ artwork.id }}" data-title="{{ artwork.title }}">Approve</button>
                                <button type="button" class="reject-btn bg-red-100 text-red-700 px-3 py-1 
                                rounded-md hover:bg-red-200 transition" data-id="{{ artwork.id }}" 
                                data-title="{{ artwork.title }}">Reject</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-md text-blue-700">
            No artworks pending approval.
        </div>
    {% endif %}
</div>

<!-- Approve Modal -->
<div id="approveModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg font-medium text-gray-900" id="approveModalLabel">Approve Artwork</h3>
            <form id="approveForm" method="POST">
                {% csrf_token %}
                <input type="hidden" id="approve-artwork-id" name="artwork_id">
                <textarea id="approve-reason" name="reason" rows="4" class="shadow appearance-none border 
                rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none 
                focus:shadow-outline" placeholder="Reason for approval" required></textarea>
                <div class="mt-4 flex justify-end space-x-2">
                    <button type="button" id="cancelApproveModal" class="px-4 py-2 bg-gray-300 text-gray-800 
                    rounded hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Approve</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg font-medium text-gray-900" id="rejectModalLabel">Reject Artwork</h3>
            <form id="rejectForm" method="POST">
                {% csrf_token %}
                <input type="hidden" id="reject-artwork-id" name="artwork_id">
                <textarea id="reject-reason" name="reason" rows="4" class="shadow appearance-none 
                border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none 
                focus:shadow-outline" placeholder="Reason for rejection" required></textarea>
                <div class="mt-4 flex justify-end space-x-2">
                    <button type="button" id="cancelRejectModal" class="px-4 py-2 bg-gray-300 text-gray-800 
                    rounded hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Reject</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
        document.addEventListener('DOMContentLoaded', function () {
            // Function to show success message
            function showSuccessMessage(message) {
                const messagesContainer = document.querySelector('.container .mb-6');
                if (!messagesContainer) {
                    // Create messages container if it doesn't exist
                    const container = document.querySelector('.container');
                    const newMessagesContainer = document.createElement('div');
                    newMessagesContainer.className = 'mb-6';
                    container.insertBefore(newMessagesContainer, container.firstChild);
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = 'p-4 rounded-lg mb-2 bg-green-500 text-white shadow';
                messageDiv.textContent = message;

                document.querySelector('.container .mb-6').appendChild(messageDiv);

                // Auto remove message after 3 seconds
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }

            // Reject functionality
            const rejectModal = document.getElementById('rejectModal');

            document.querySelectorAll('.reject-btn').forEach(button => {
                button.addEventListener('click', function () {
                    document.getElementById('reject-artwork-id').value = this.dataset.id;
                    rejectModal.classList.remove('hidden');
                });
            });

            document.getElementById('cancelRejectModal').addEventListener('click', () => 
                rejectModal.classList.add('hidden')
            );

            document.getElementById('rejectForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const artworkTitle = document.querySelector(`tr[data-artwork-id="${formData.get('artwork_id')}"]`)
                    .querySelector('td:first-child').textContent;

                fetch('{% url "accounts:reject_artwork_ajax" %}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const artworkId = formData.get('artwork_id');
                        const row = document.querySelector(`tr[data-artwork-id="${artworkId}"]`);
                        if (row) {
                            row.remove();
                        }
                        rejectModal.classList.add('hidden');
                        showSuccessMessage(`Artwork "${artworkTitle}" has been rejected successfully.`);
                        this.reset();

                        // Check if table is empty
                        if (document.querySelectorAll('tbody tr').length === 0) {
                            location.reload(); // Reload to show "No artworks pending" message
                        }
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while rejecting the artwork');
                });
            });

            // Approve functionality
            const approveModal = document.getElementById('approveModal');

            document.querySelectorAll('.approve-btn').forEach(button => {
                button.addEventListener('click', function () {
                    document.getElementById('approve-artwork-id').value = this.dataset.id;
                    approveModal.classList.remove('hidden');
                });
            });

            document.getElementById('cancelApproveModal').addEventListener('click', () => 
                approveModal.classList.add('hidden')
            );

            document.getElementById('approveForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const artworkTitle = document.querySelector(`tr[data-artwork-id="${formData.get('artwork_id')}"]`)
                    .querySelector('td:first-child').textContent;

                fetch('{% url "accounts:approve_artwork_ajax" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const artworkId = formData.get('artwork_id');
                        const row = document.querySelector(`tr[data-artwork-id="${artworkId}"]`);
                        if (row) {
                            row.remove();
                        }
                        approveModal.classList.add('hidden');
                        showSuccessMessage(`Artwork "${artworkTitle}" has been approved successfully.`);
                        this.reset();

                        // Check if table is empty
                        if (document.querySelectorAll('tbody tr').length === 0) {
                            location.reload(); // Reload to show "No artworks pending" message
                        }
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while approving the artwork');
                });
            });
        });
</script>
{% endblock %}