{% extends "base.html" %}

{% block content %}
<div class="bg-gray-100 min-h-screen p-8">
    {% if messages %}
        <div class="max-w-6xl mx-auto mb-6">
            {% for message in messages %}
                <div class="p-4 rounded-lg mb-2 {% if message.tags == 'success' %} bg-green-500 {% else %} bg-red-500 {% endif %} text-white shadow">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    <div class="max-w-6xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
        <!-- Profile Header -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center space-x-6">
                <div class="flex-shrink-0">
                    <svg class="h-20 w-20 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
                <div class="flex-grow">
                    <h2 class="text-2xl font-bold text-gray-900">{{ user.username }}</h2>
                    <p class="text-gray-600">{{ user.email }}</p>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'accounts:update_profile' %}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">Edit Profile</a>
                </div>
            </div>
        </div>

    <div class="border-b border-gray-200">
        <nav class="flex -mb-px">
            <button onclick="showTab('messages')" class="tab-button text-gray-600 py-4 px-6 block hover:text-gray-700 font-medium border-b-2 border-transparent">
                Messages
                <span id="unread-count" class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
            </button>
            <button onclick="showTab('orders')" class="tab-button active text-gray-600 py-4 px-6 block hover:text-gray-700 font-medium border-b-2 border-blue-500">
                Your Orders
            </button>
        </nav>
    </div>
        
        <!-- Orders Section -->
        <div id="orders-tab" class="tab-content p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Orders</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">Order Name</th>
                            <th scope="col" class="px-6 py-3">Category</th>
                            <th scope="col" class="px-6 py-3">Price</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3 text-right">Order Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if orders %}
                            {% for order in orders %}
                                <tr class="bg-white border-b hover:bg-gray-50 transition">
                                    <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">
                                        {{ order.artwork.title }}
                                    </th>
                                    <td class="px-6 py-4">{{ order.artwork.category }}</td>
                                    <td class="px-6 py-4">${{ order.total_price }}</td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium
                                            {% if order.payment_status == 'Completed' %} bg-green-100 text-green-800
                                            {% elif order.payment_status == 'Pending' %} bg-yellow-100 text-yellow-800
                                            {% else %} bg-gray-100 text-gray-800
                                            {% endif %}">
                                            {{ order.payment_status }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        {{ order.created_at|date:"M d, Y" }} at {{ order.created_at|time:"h:i A" }}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr class="bg-white">
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                    No orders found.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
         <!-- Messages Section -->
    <div id="messages-tab" class="tab-content p-6 hidden">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Your Messages</h2>
        
        <div class="space-y-4">
            {% for conversation in conversations %}
            <div class="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-medium text-gray-900">{{ conversation.artwork.title }}</h3>
                        <p class="text-sm text-gray-600">
                            To: {{ conversation.artwork.designer.username }}
                        </p>
                    </div>
                    <span class="text-xs text-gray-500">
                        {{ conversation.latest_message.created_at|timesince }} ago
                    </span>
                </div>
                <div class="text-sm text-gray-700 mb-2">
                    {{ conversation.latest_message.message|truncatechars:100 }}
                </div>
                <button onclick="openChatModal('{{ conversation.artwork.id }}', '{{ conversation.artwork.designer.username }}')" 
                        class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                    View Conversation
                </button>
                 </div>
            {% empty %}
            <div class="text-center text-gray-500 py-8">
                No message threads yet. Start a conversation by viewing an artwork!
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Modal -->
                    <div id="chatModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                        <div class="relative top-20 mx-auto p-5 border w-[500px] shadow-lg rounded-md bg-white max-w-xl">
                            <div class="flex justify-between items-center mb-4 border-b pb-4">
                                <h3 class="text-lg font-semibold text-gray-900" id="chatTitle">Loading...</h3>
                                <button onclick="closeChatModal()" class="text-gray-500 hover:text-gray-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                                <div id="messageLoading" class="hidden text-center py-4">
                                    <svg class="animate-spin h-5 w-5 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>

                            
                            <div id="messageContainer" class="h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded space-y-4 flex flex-col">
                                <!-- Messages will be loaded here -->
                            </div>
                    <form id="replyForm" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" id="artwork_id" name="artwork_id">
                        
                        <!-- Reply context display (shows what message is being replied to) -->
                        <div id="replyContext" class="px-3 py-2 bg-gray-100 border-l-4 border-gray-300 text-sm text-gray-700 rounded mb-2 hidden">
                            <p class="font-medium text-xs text-gray-500 mb-1">Replying to:</p>
                            <p id="replyContextText"></p>
                        </div>
                        
                        <div class="flex items-end space-x-2">
                            <textarea name="message" 
                                    class="flex-1 p-2 border rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                    rows="3" 
                                    placeholder="Type your message..." 
                                    required></textarea>
                            <button type="submit" 
                                    class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                </svg>
                            </button>
                        </div>
                    </form>
                    </div>
                </div>
            </div>

    </div>
</div>
<script>
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
        button.classList.remove('border-purple-500');
        button.classList.add('border-transparent');
    });
    
    // Show selected tab content
    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
    
    // Add active class to clicked button
    event.currentTarget.classList.add('active');
    event.currentTarget.classList.add('border-purple-500');
}
function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}


            function loadMessages(artworkId) {
                const container = document.getElementById('messageContainer');
                const loading = document.getElementById('messageLoading');
                
                loading.classList.remove('hidden');
                container.classList.add('opacity-50');
                
                fetch(`{% url 'get_messages' 0 %}`.replace('0', artworkId))
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        container.classList.remove('opacity-50');
                        loading.classList.add('hidden');
                        
                        let lastDate = '';
                        let messagesHTML = '';
                        let lastUserMessage = null;
                        
                        // Find the last message not from the current user (for reply context)
                            for (let i = data.messages.length - 1; i >= 0; i--) {
                                if (data.messages[i].sender__username !== '{{ user.username }}') {
                                    lastUserMessage = data.messages[i];
                                    break;
                                }
                            }

                            // If we found a message and current user is the artist/designer
                            if (lastUserMessage) {
                                setReplyContext(lastUserMessage.message);
                            }
                        
                        // Generate the messages HTML
                        data.messages.forEach(msg => {
                            const messageDate = new Date(msg.created_at).toLocaleDateString();
                            if (messageDate !== lastDate) {
                                lastDate = messageDate;
                                messagesHTML += `
                                    <div class="flex justify-center my-2">
                                        <span class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full">
                                            ${messageDate}
                                        </span>
                                    </div>
                                `;
                            }
                            
                            const isCurrentUser = msg.sender__username === '{{ user.username }}';
                            const escapedMessage = msg.message.replace(/'/g, "\\'").replace(/"/g, '\\"');
                            
                            messagesHTML += `
                                <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-3">
                                    <div class="max-w-[70%] break-words rounded-lg px-4 py-2 ${
                                        isCurrentUser 
                                        ? 'bg-blue-500 text-white rounded-br-none' 
                                        : 'bg-gray-200 text-gray-800 rounded-bl-none'
                                    }">
                                        <p class="text-sm">${msg.message}</p>
                                        <div class="flex justify-between items-center mt-1">
                                            ${!isCurrentUser ? `
                                            <button type="button" onclick="replyToMessage('${escapedMessage}')" 
                                                    class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-500'} hover:underline">
                                                Reply
                                            </button>` : ''}
                                            <span class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-500'} ${!isCurrentUser ? 'ml-auto' : ''}">
                                                ${formatTimestamp(msg.created_at)}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = messagesHTML;
                        container.scrollTop = container.scrollHeight;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        loading.classList.add('hidden');
                        container.classList.remove('opacity-50');
                        container.innerHTML = '<div class="text-center text-red-500">Failed to load messages</div>';
                    });
            }
        document.getElementById('replyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const textarea = this.querySelector('textarea');
            const submitButton = this.querySelector('button[type="submit"]');
            
            if (!textarea.value.trim()) return;
            
            // Disable form while sending
            textarea.disabled = true;
            submitButton.disabled = true;
            
            fetch('{% url "send_message" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.reset();
                    // Clear reply context after successful send
                    setReplyContext(null);
                    loadMessages(formData.get('artwork_id'));
                }
            })
            .finally(() => {
                // Re-enable form
                textarea.disabled = false;
                submitButton.disabled = false;
                textarea.focus();
            });
        });
// Auto-refresh messages every 5 seconds when chat is open
let messageRefreshInterval;

function openChatModal(artworkId, senderName) {
    document.getElementById('chatModal').classList.remove('hidden');
    document.getElementById('chatTitle').textContent = `Chat with ${senderName}`;
    document.getElementById('artwork_id').value = artworkId;
    
    // Clear any existing reply context
    setReplyContext(null);
    
    // Load messages
    loadMessages(artworkId);
    
    // Start auto-refresh
    messageRefreshInterval = setInterval(() => {
        loadMessages(artworkId);
    }, 5000);
}
function closeChatModal() {
    document.getElementById('chatModal').classList.add('hidden');
    // Clear auto-refresh when closing
    clearInterval(messageRefreshInterval);
}


// Update the check new messages URL
setInterval(() => {
    if (document.getElementById('messages-tab').classList.contains('hidden')) return;
    
    fetch('{% url "check_new_messages" %}')
        .then(response => response.json())
        .then(data => {
            if (data.unread_count > 0) {
                const unreadBadge = document.getElementById('unread-count');
                unreadBadge.textContent = data.unread_count;
                unreadBadge.classList.remove('hidden');
            }
        });
}, 30000);

// Function to show reply context
function setReplyContext(message) {
    const contextDiv = document.getElementById('replyContext');
    const contextText = document.getElementById('replyContextText');
    
    if (message) {
        contextText.textContent = message;
        contextDiv.classList.remove('hidden');
    } else {
        contextDiv.classList.add('hidden');
    }
}

// Function to handle replying to a specific message
function replyToMessage(message) {
    setReplyContext(message);
    document.querySelector('#replyForm textarea').focus();
}

function quickReply(text) {
    document.querySelector('#replyForm textarea').value = text;
}

</script>

<style>
.tab-button.active {
    color: #6B46C1;
}

.tab-button {
    transition: all 0.3s ease;
}

.tab-button:hover {
    color: #6B46C1;
}

.tab-content {
    transition: all 0.3s ease;
}
</style>
{% endblock %}